<!-- "v0.11" -->

<!DOCTYPE html>

<html lang="en" dir="ltr">

	<head>
	  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">-->
	  <style>
            input[type="text"],
			input[type="number"],
			textarea,
			select {
				font-size: 20px;
			}
       </style>
	</head>

	<body>
		<canvas width="640" height="640" style="border:1px solid #000000;" id="GameScreen"></canvas>
		
		<div id="ConsoleComponents">
			<input type="text" id="ToAdd" style="font-size: 20px"></input>
			<button id="ToAddButton">Enter</button>
		</div>
		
		<canvas width="640" height="480" style="border:1px solid #000000;" id="touchControls"></canvas>
	</body>

	<script src="https://cdn.jsdelivr.net/gh/BradSamott/BradSamott.github.io/testpull.js"></script>

	<script>
		ver = '0.2'
	</script>
	
	<script>
		console.log('Key Logger');
		
		var keys = {
			//65: {key: 'a', pressed: false},
			//83: {key: 's', pressed: false}
		}
		
		// This function will be called when a key on the keyboard is pressed
		function keydown(e) {
		
			if(keys[e.keyCode] != null) {
				keys[e.keyCode].pressed = true;
			}
			
			/*
			// 37 is the code for the left arrow key
			if(e.keyCode == 37) {
				keys.left = true;
			}
			
			// 38 is the code for the up arrow key
			if(e.keyCode == 38) {
				keys.up = true;
			}
			
			// 39 is the code for the right arrow key
			if(e.keyCode == 39) {
				keys.right = true;
			}
			
			// 40 is the code for the down arrow key
			if(e.keyCode == 40) {
				keys.down = true;
			}
			
			// 32 is the code for the space key
			if(e.keyCode == 32) {
				keys.space = true;
			}
			*/
			
		}
			
		// This function is called when the pressed key is released
		function keyup(e) {
		
			if(keys[e.keyCode] != null) {
				keys[e.keyCode].pressed = false;
			}
		
		}
		
		// Adding the event listeners
		document.addEventListener("keydown",keydown);
		document.addEventListener("keyup",keyup);
		
		window.addEventListener('keydown', function(event) {
			if(event.keyCode == 32) {
				if(event.target.tagName != 'INPUT' && event.target.tagName != 'TEXTAREA' && !event.target.isContentEditable) {
					event.preventDefault();
				}
			} else if(event.keyCode == 38) {
				event.preventDefault();
			} else if(event.keyCode == 40) {
				event.preventDefault();
			}
		});
		
		
		var touchButtons = [
		/*
			{
			 x: 100,
			 y: 100,
			 r: 50,
			 downPress: function() {
				console.log('1 Pressed');
			 },
			 upPress: function() {
				console.log('1 Unressed');
			 }
			},
			{
			 x: 200,
			 y: 200,
			 r: 50,
			 downPress: function() {
				console.log('2 Pressed');
			 },
			 upPress: function() {
				console.log('2 Unressed');
			 }
			}
		*/
		];
		
		var touchControls = document.getElementById("touchControls");
		
		function downEvent(event) {
			//console.log('touching');
			let pos = { x: event.clientX, y: event.clientY };
			if (event.touches) {
				pos = { x: event.touches[0].clientX, y: event.touches[0].clientY };
			}		
			const rect = event.target.getBoundingClientRect();
			const x_rel = pos.x - rect.left;
			const y_rel = pos.y - rect.top;
			const x = Math.round((x_rel * event.target.width) / rect.width);
			const y = Math.round((y_rel * event.target.height) / rect.height);
			console.log(x);
			console.log(y);
			
			for(var i = 0; i < touchButtons.length; i++) {
				var xM = (touchButtons[i].x - x)*(touchButtons[i].x - x);
				var yM = (touchButtons[i].y - y)*(touchButtons[i].y - y);
				if(Math.sqrt(xM + yM) <= touchButtons[i].r) {
					touchButtons[i].downPress();
				}
			}
		}
		
		function upEvent(event) {
			//console.log('touching');
			let pos = { x: event.clientX, y: event.clientY };
			if (event.touches) {
				pos = { x: event.touches[0].clientX, y: event.touches[0].clientY };
			}		
			const rect = event.target.getBoundingClientRect();
			const x_rel = pos.x - rect.left;
			const y_rel = pos.y - rect.top;
			const x = Math.round((x_rel * event.target.width) / rect.width);
			const y = Math.round((y_rel * event.target.height) / rect.height);
			console.log(x);
			console.log(y);
			
			for(var i = 0; i < touchButtons.length; i++) {
				var xM = (touchButtons[i].x - x)*(touchButtons[i].x - x);
				var yM = (touchButtons[i].y - y)*(touchButtons[i].y - y);
				if(Math.sqrt(xM + yM) <= touchButtons[i].r) {
					touchButtons[i].upPress();
				}
			}
		}
		
		touchControls.addEventListener('mousedown', downEvent);
		touchControls.addEventListener('touchstart', downEvent);
		touchControls.addEventListener('mouseup', upEvent);
		touchControls.addEventListener('touchend', upEvent);
	</script>
	
	<script>
		var canvasGameScreen = document.getElementById("GameScreen");
		var ctxGameScreen = canvasGameScreen.getContext("2d");
		
		var initRes = 128;
		var initBitSize = canvasGameScreen.width / initRes;
		
		var initBitDrawMap = Array(initRes).fill().map(() => Array(initRes).fill().map(() => Array(3).fill(-1)));
	
		objHandler = {
			objs: [],
			cBuff: [],
			GS: canvasGameScreen,
			CTX: ctxGameScreen,
			maxUpdateLayer: -1,
			maxDrawLayer: -1,
			res: initRes,
			bitSize: initBitSize,
			bitDrawMap: initBitDrawMap,
			checkKeys: {
				//a: {curr: false, last: false},
				//s: {curr: false, last: false}
			},
			
			getKeys: function() {
				for (var key in keys){
					if(this.checkKeys[keys[key].key] != null) {
						if(keys[key].pressed) {
							if(this.checkKeys[keys[key].key].curr == true) {
								this.checkKeys[keys[key].key].last = true;
							} else {
								this.checkKeys[keys[key].key].last = false;
							}
							this.checkKeys[keys[key].key].curr = true;
						} else {
							if(this.checkKeys[keys[key].key].curr == true) {
								this.checkKeys[keys[key].key].last = true;
							} else {
								this.checkKeys[keys[key].key].last = false;
							}
							this.checkKeys[keys[key].key].curr = false;
						}
					}
				}
			},
			
			tickObjects: function() {
				for(var lay = 0; lay <= this.maxUpdateLayer; lay++) {
					for(var i = 0; i < this.objs.length; i++) {
						if(this.objs[i].updateFunctions[lay] != null) {
							this.objs[i].updateFunctions[lay](this.objs[i]);
						}
					}
				}
			},
			
			clearScreen: function() {
				this.CTX.clearRect(0, 0, this.GS.width, this.GS.height);
				this.bitDrawMap = Array(this.res).fill().map(() => Array(this.res).fill().map(() => Array(3).fill(-1)));
			},
			
			renderObjects: function() {
				for(var lay = 0; lay <= this.maxDrawLayer; lay++) {
					for(var i = 0; i < this.objs.length; i++) {
						if(this.objs[i].drawFunctions[lay] != null) {
							this.objs[i].drawFunctions[lay](this.objs[i]);
						}
					}
				}
				
				for(var xC = 0; xC < this.bitDrawMap.length; xC++) {
					for(var yC = 0; yC < this.bitDrawMap[xC].length; yC++) {
						if(this.bitDrawMap[xC][yC][0] != -1) {
							this.CTX.fillStyle = 'rgb('+this.bitDrawMap[xC][yC][0]+','+this.bitDrawMap[xC][yC][1]+','+this.bitDrawMap[xC][yC][2]+')'
							this.CTX.fillRect(xC * this.bitSize, yC * this.bitSize, this.bitSize, this.bitSize);
						}
					}
				}
			},
			
			addObject: function(newObj) {
				newObj.handler = this;
				this.objs.push(newObj);
				
				if(newObj.updateFunctions.length - 1 > this.maxUpdateLayer) {
					this.maxUpdateLayer = newObj.updateFunctions.length - 1
				}
				
				if(newObj.drawFunctions.length - 1 > this.maxDrawLayer) {
					this.maxDrawLayer = newObj.drawFunctions.length - 1
				}
			},
			
			clearCBuff() {
				this.cBuff = [];
			},
			
			pset(x, y, r, g, b) {
				if(r != -1) {
					this.bitDrawMap[x][y][0] = r;
					this.bitDrawMap[x][y][1] = g;
					this.bitDrawMap[x][y][2] = b;
				}
			},
			
			drawFromMap(x, y, map, startX, startY, w, l, palette) {
				for(var i = 0; i < w; i++) {
					for(var j = 0; j < l; j++) {
						this.pset(x + i
								  , y + j
								  , palette[map[startY + j][startX + i]][0]
								  , palette[map[startY + j][startX + i]][1]
								  , palette[map[startY + j][startX + i]][2]
								 );
					}
				}
			},
			
			print(x, y, text, alphabelMap, aL, letterLength, palette) {
				for(var i = 0; i < text.length; i++) {
					if (aL[text.charAt(i)] != null) {
						this.drawFromMap(x + ((letterLength+1)*i), y, alphabelMap, aL[text.charAt(i)].startX, aL[text.charAt(i)].startY, aL[text.charAt(i)].w, aL[text.charAt(i)].l, palette);
					}
				}
			}
		}
		
		function getMousePos(canvas, evt) {
			var rect = canvas.getBoundingClientRect();
			return {
			  x: evt.clientX - rect.left,
			  y: evt.clientY - rect.top
			};
		}
		
		function getClick(e) {
			var mousepos = getMousePos(objHandler.GS,e);
			objHandler.cBuff.push(mousepos);
		}
		
		objHandler.GS.addEventListener('click',getClick,false);
	
		function gameLoop() {
			objHandler.getKeys();
			objHandler.clearScreen();
			objHandler.tickObjects();
			objHandler.renderObjects();
			objHandler.clearCBuff();
		}
		
		setInterval(gameLoop,33);
		
		console.log('Resize Set');
		
		function windowResizeAction() {
			console.log('Resize');
			
			var canvasGameScreen = document.getElementById("GameScreen");
			var ctxGameScreen = canvasGameScreen.getContext("2d");
			
			var side = window.innerWidth;
			
			console.log(side - 60);
			
			if(side - 60 > 900) {
				canvasGameScreen.width = 900;
				canvasGameScreen.height = 900;
			}
			else if(side - 60 < 500) {
				canvasGameScreen.width = 500;
				canvasGameScreen.height = 500;
			}
			else {
				canvasGameScreen.width = side - 60;
				canvasGameScreen.height = side - 60;
			}
			
			canvasGameScreen.style.position = 'absolute';
			canvasGameScreen.style.left = '50%';
			canvasGameScreen.style.transform = 'translate(-50%)';
			
			objHandler.bitSize = canvasGameScreen.width / objHandler.res;
			
			var consoleComponents = document.getElementById("ConsoleComponents");
			var canvasElemBound = canvasGameScreen.getBoundingClientRect();
			
			consoleComponents.style.position = 'absolute';
			consoleComponents.style.left = ''+canvasElemBound.left+'px';
			consoleComponents.style.top = ''+(canvasElemBound.bottom + 20)+'px';
			
			
			var touchControls = document.getElementById("touchControls");
			touchControls.width = canvasGameScreen.width;
			touchControls.height = canvasGameScreen.height * 0.75
			touchControls.style.position = 'absolute';
			touchControls.style.left = '50%';
			touchControls.style.transform = 'translate(-50%)';
			touchControls.style.top = ''+(canvasElemBound.bottom + 50)+'px';
			
			var tctx = touchControls.getContext('2d');
			for(var i = 0; i < touchButtons.length; i++) {
				
				//draw buttons
				tctx.beginPath();
				tctx.arc(touchButtons[i].x, touchButtons[i].y, touchButtons[i].r, 0, 2 * Math.PI);
				tctx.strokeStyle = 'black'; // Set stroke color
				tctx.lineWidth = 3; // Set line width
				tctx.stroke();
				
				tctx.font = "15px serif";
				tctx.textAlign = "center";
				tctx.textBaseline = "middle";
				tctx.fillText(touchButtons[i].buttonLabel, touchButtons[i].x, touchButtons[i].y);
			}
		}
		
		windowResizeAction();
		
		window.addEventListener('resize', windowResizeAction)
	</script>

	<script>
		var CheckBucket = {
		
		}
	
		var toAddButton = document.getElementById("ToAddButton");
		
		function activateGame() {
			console.log('Adding');
		
			scriptCheck = document.getElementById("ScriptCheck");
			addedScripts = document.getElementById("AddedScripts");
			const newGameScript = document.createElement('script');
			const newCheckScript = document.createElement('script');
			
			var toAddText = document.getElementById("ToAdd");
			var arg = toAddText.value;
			var cleanedArg = arg.replace(/[^a-zA-Z0-9]/g, "");
			
			CheckBucket[cleanedArg] = false;
			
			var urlPrefix = '';
			//urlPrefix = "https://cdn.jsdelivr.net/gh/BradSamott/BradSamott.github.io/v"+ver+"/"
			urlPrefix = "WorkFolder/"
			
			newCheckScript.src = urlPrefix+cleanedArg+"Check.js"
			addedScripts.appendChild(newCheckScript);
			//var scripts = document.getElementsByTagName('script');
			//var found = false;
			//for (var i = scripts.length; i--;) {
		//		if (scripts[i].src == urlPrefix+cleanedArg+"Check.js") {
		//			found = true;
		//		}
		//	}
			
			/*
				objHandler.objs = [];
				objHandler.cBuff = [];
				objHandler.maxUpdateLayer = -1;
				objHandler.maxDrawLayer = -1;
				objHandler.checkKeys = {};
				keys = {};
				touchButtons = [];
				var tctx = touchControls.getContext('2d');
				tctx.clearRect(0, 0, touchControls.width, touchControls.height);
				
				addedScripts.innerHTML = '';
				
				//alert("Game Start");
				console.log(cleanedArg);
				//newGameScript.src = "https://cdn.jsdelivr.net/gh/BradSamott/BradSamott.github.io/v"+ver+"/"+cleanedArg+".js"
				//newGameScript.src = "WorkFolder/"+cleanedArg+".js"
				newGameScript.src = urlPrefix+cleanedArg+".js"
				addedScripts.appendChild(newGameScript);
				toAddText.value = '';
			*/
		}
		
		toAddButton.addEventListener("click", activateGame);
		//toAddButton.addEventListener("touchstart", activateGame);
	</script>
	
	<div id="ScriptCheck">
	
	</div>
	
	<div id="AddedScripts">
		<!--<script src="https://cdn.jsdelivr.net/gh/BradSamott/BradSamott.github.io/randomTests_v2.js"></script>-->
		<!--<script src="randomTests.js"></script>-->
		<!--<script src="AedynsGame.js"></script>-->
		<!--<script src="https://cdn.jsdelivr.net/gh/BradSamott/BradSamott.github.io/AedynsGame_v0.js"></script>-->
	</div>

</html>

